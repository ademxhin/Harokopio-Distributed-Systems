<!DOCTYPE html>
<html
        lang="en"
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{base}">

<th:block layout:fragment="head">
    <title>GreenRide | Homepage</title>

    <link rel="stylesheet" th:href="@{/css/theme.css}">

    <link rel="stylesheet" th:href="@{/css/homepage.css}">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</th:block>


<main layout:fragment="main" class="gr-page">
    <section class="gr-hero">
        <div class="container">
            <div class="gr-hero-grid">

                <div class="gr-panel">
                    <h1 class="gr-title">Go anywhere with GreenRide</h1>
                    <p class="gr-subtitle">
                        A distributed system demo for connecting users and drivers with a simple workflow.
                    </p>

                    <div class="gr-weather-card"
                         th:if="${weather != null}"
                         th:classappend="${
                            #strings.containsIgnoreCase(weather.condition, 'rain') ? ' gr-weather-rain' :
                            (#strings.containsIgnoreCase(weather.condition, 'storm') ? ' gr-weather-storm' :
                            (#strings.containsIgnoreCase(weather.condition, 'snow') ? ' gr-weather-snow' :
                            (#strings.containsIgnoreCase(weather.condition, 'cloud') ? ' gr-weather-cloudy' :
                            ' gr-weather-clear')))
                         }">

                        <div class="gr-weather-top">
                            <div class="gr-weather-leftcol">
                                <div class="gr-weather-location" th:text="${weatherLocation}">Athens</div>
                                <div class="gr-weather-condition" th:text="${weather.condition}">Partly Cloudy</div>
                            </div>

                            <div class="gr-weather-icon"
                                 th:text="${
                                    #strings.containsIgnoreCase(weather.condition, 'rain') ? 'üåßÔ∏è' :
                                    (#strings.containsIgnoreCase(weather.condition, 'storm') ? '‚õàÔ∏è' :
                                    (#strings.containsIgnoreCase(weather.condition, 'snow') ? 'üå®Ô∏è' :
                                    (#strings.containsIgnoreCase(weather.condition, 'cloud') ? '‚õÖ' :
                                    '‚òÄÔ∏è')))
                                 }">‚õÖ</div>
                        </div>

                        <div class="gr-weather-temp-big"
                             th:text="${#numbers.formatDecimal(weather.temperatureCelsius, 1, 1)} + '¬∞C'">15.6¬∞C</div>
                    </div>

                    <div class="gr-weather-card gr-weather-error" th:if="${weather == null}">
                        <div class="gr-weather-top">
                            <div class="gr-weather-leftcol">
                                <div class="gr-weather-location" th:text="${weatherLocation}">Athens</div>
                                <div class="gr-weather-condition" th:text="${weatherError}">Weather service unavailable</div>
                            </div>
                            <div class="gr-weather-icon">‚ö†Ô∏è</div>
                        </div>
                        <div class="gr-weather-temp-big">‚Äî</div>
                    </div>

                    <div class="gr-box">

                        <div class="gr-subbox">
                            <div class="gr-search-head">
                                <div class="gr-search-title">Where do you wanna go?</div>
                                <div class="gr-search-sub">
                                    Enter pickup, destination, date and time to see available rides.
                                </div>
                            </div>

                            <form class="gr-search-form" th:action="@{/rides/search}" method="get">

                                <div class="gr-search-grid">
                                    <div class="gr-input">
                                        <label class="gr-label" for="from">From</label>
                                        <input class="gr-control"
                                               id="from"
                                               name="from"
                                               type="text"
                                               placeholder="e.g. Kallithea"
                                               required>
                                    </div>

                                    <div class="gr-input">
                                        <label class="gr-label" for="to">To</label>
                                        <input class="gr-control"
                                               id="to"
                                               name="to"
                                               type="text"
                                               placeholder="e.g. Syntagma"
                                               required>
                                    </div>

                                    <div class="gr-input">
                                        <label class="gr-label" for="date">Date</label>
                                        <input class="gr-control"
                                               id="date"
                                               name="date"
                                               type="date"
                                               required>
                                    </div>

                                    <div class="gr-input">
                                        <label class="gr-label" for="time">Time</label>
                                        <select class="gr-control"
                                                id="time"
                                                name="time"
                                                required>
                                        </select>
                                    </div>
                                </div>

                                <button type="submit" class="gr-btn gr-btn-primary">
                                    Search rides
                                </button>

                            </form>
                        </div>

                        <script>
                            document.addEventListener("DOMContentLoaded", function () {
                                const dateEl = document.getElementById("date");
                                const timeEl = document.getElementById("time");
                                if (!dateEl || !timeEl) return;

                                function pad2(n){ return String(n).padStart(2, "0"); }

                                const stepMinutes = 10;
                                timeEl.innerHTML = "";

                                for (let h = 0; h < 24; h++) {
                                    for (let m = 0; m < 60; m += stepMinutes) {
                                        const isPM = h >= 12;
                                        let h12 = h % 12;
                                        if (h12 === 0) h12 = 12;

                                        const label = `${pad2(h12)}:${pad2(m)} ${isPM ? "PM" : "AM"}`;
                                        const opt = document.createElement("option");
                                        opt.value = label;
                                        opt.textContent = label;
                                        timeEl.appendChild(opt);
                                    }
                                }

                                const now = new Date();
                                const todayStr = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;
                                dateEl.min = todayStr;

                                const plus30 = new Date(now.getTime() + 10 * 60 * 1000);

                                let H24 = plus30.getHours();
                                let M = plus30.getMinutes();

                                const rounded = Math.ceil(M / stepMinutes) * stepMinutes;
                                if (rounded === 60) {
                                    plus30.setHours(H24 + 1);
                                    plus30.setMinutes(0, 0, 0);
                                } else {
                                    plus30.setMinutes(rounded, 0, 0);
                                }

                                const defaultDate = `${plus30.getFullYear()}-${pad2(plus30.getMonth()+1)}-${pad2(plus30.getDate())}`;
                                if (!dateEl.value) dateEl.value = defaultDate;

                                const HH = plus30.getHours();
                                const MM = plus30.getMinutes();

                                const isPM = HH >= 12;
                                let H12 = HH % 12;
                                if (H12 === 0) H12 = 12;

                                const defaultTime = `${pad2(H12)}:${pad2(MM)} ${isPM ? "PM" : "AM"}`;
                                timeEl.value = defaultTime;
                            });
                        </script>
                    </div>
                </div>

                <div class="gr-map">
                    <div class="gr-mini-map-wrap">
                        <div class="gr-mini-map-header">
                            <div class="gr-mini-map-title">Route estimate</div>

                            <div class="gr-mini-map-meta" th:if="${route != null}">
                                <span th:text="${#numbers.formatDecimal(route.distanceMeters/1000.0,1,1)} + ' km'">4.4 km</span>
                                <span class="gr-mini-map-dot">‚Ä¢</span>
                                <span th:text="${T(java.lang.Math).round(route.durationSeconds/60.0)} + ' min'">11 min</span>
                            </div>

                            <div class="gr-mini-map-meta gr-mini-map-meta-error" th:if="${route == null}">
                                <span th:text="${routeError != null ? routeError : 'Route unavailable'}">Route unavailable</span>
                            </div>
                        </div>

                        <div id="gr-mini-map" class="gr-mini-map gr-mini-map-fill" aria-label="Mini map"></div>
                    </div>
                </div>

            </div>
        </div>
    </section>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function () {

            const routeCoords = /*[[${route != null ? route.polyline : null}]]*/ null;
            const fallbackCenter = [37.9838, 23.7275];

            const map = L.map('gr-mini-map', {
                zoomControl: false,
                attributionControl: false
            });

            L.tileLayer(
                'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                { maxZoom: 19 }
            ).addTo(map);

            const routeStyle = {
                className: 'gr-route-line',
                weight: 6,
                opacity: 0.95,
                lineCap: 'round',
                lineJoin: 'round'
            };

            const startPointStyle = {
                className: 'gr-route-point gr-route-point-start',
                radius: 7,
                opacity: 1,
                fillOpacity: 1
            };

            const endPointStyle = {
                className: 'gr-route-point gr-route-point-end',
                radius: 7,
                opacity: 1,
                fillOpacity: 1
            };

            if (routeCoords && Array.isArray(routeCoords) && routeCoords.length > 1) {
                const latLngs = routeCoords.map(p => [p[1], p[0]]);

                const polyline = L.polyline(latLngs, routeStyle).addTo(map);
                L.circleMarker(latLngs[0], startPointStyle).addTo(map);
                L.circleMarker(latLngs[latLngs.length - 1], endPointStyle).addTo(map);

                map.fitBounds(polyline.getBounds(), { padding: [16, 16] });
            } else {
                map.setView(fallbackCenter, 12);
            }

            L.control.zoom({ position: 'bottomright' }).addTo(map);
        });
    </script>
</main>

</html>