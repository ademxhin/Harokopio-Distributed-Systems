<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">

<th:block layout:fragment="head">
    <title>GreenRide | Ratings</title>

    <!-- Page-specific CSS -->
    <link rel="stylesheet" th:href="@{/css/ratings.css}">
</th:block>

<main layout:fragment="main" class="gr-ratings-page">
    <section class="gr-ratings-page">
        <div class="container gr-ratings-wrap">

            <!-- Header -->
            <header class="gr-ratings-head">
                <h1 class="gr-ratings-title">Ratings</h1>
                <p class="gr-ratings-sub">Evaluate your experience with other users</p>
            </header>

            <!-- Search -->
            <div class="gr-box gr-box-pad gr-ratings-card">
                <form th:action="@{/rides/ratings}" method="get" class="gr-search">
                    <input type="text"
                           name="search"
                           class="gr-control"
                           placeholder="Search by name..."
                           th:value="${param.search}" />

                    <button type="submit" class="gr-btn gr-btn-primary">
                        Search
                    </button>
                </form>
            </div>

            <!-- Empty state -->
            <div th:if="${#lists.isEmpty(users)}"
                 class="gr-box gr-box-pad gr-ratings-card gr-empty"
                 style="margin-top: 14px;">
                <h3>No Users Found</h3>
                <p>Try a different name or check back later.</p>

                <div class="gr-actions">
                    <a th:href="@{/profile}" class="gr-btn gr-btn-secondary">← Back to Profile</a>
                </div>
            </div>

            <!-- Users list -->
            <div th:if="${not #lists.isEmpty(users)}" class="gr-users">

                <article th:each="user : ${users}" class="gr-box gr-box-pad gr-ratings-card">

                    <!-- Top row: name + average rating -->
                    <div class="gr-user-top">
                        <h3 class="gr-user-name"
                            th:text="${user.firstName + ' ' + user.lastName}">
                            Name
                        </h3>

                        <!-- ⭐ Average rating (read-only) -->
                        <div class="gr-avg-wrap" th:with="avg=${user.averageRating}">
                            <div class="gr-stars" aria-label="Average rating">
                                <span class="gr-star" th:classappend="${avg >= 1} ? ' filled'">★</span>
                                <span class="gr-star" th:classappend="${avg >= 2} ? ' filled'">★</span>
                                <span class="gr-star" th:classappend="${avg >= 3} ? ' filled'">★</span>
                                <span class="gr-star" th:classappend="${avg >= 4} ? ' filled'">★</span>
                                <span class="gr-star" th:classappend="${avg >= 5} ? ' filled'">★</span>
                            </div>

                            <span class="gr-avg-number"
                                  th:text="${avg != null and avg > 0} ? ${#numbers.formatDecimal(avg,1,1)} : 'No rating'">
                                4.2
                            </span>
                        </div>
                    </div>

                    <!-- Rate with clickable stars -->
                    <form th:action="@{/rides/ratings/submit}"
                          method="post"
                          class="gr-rate-row gr-rate-stars-form">

                        <input type="hidden" name="userId" th:value="${user.id}" />
                        <input type="hidden" name="score" class="gr-score-input" value="" />

                        <div class="gr-stars gr-stars-picker" role="radiogroup" aria-label="Choose rating">
                            <button type="button" class="gr-star-btn" data-value="1" aria-label="1 star">★</button>
                            <button type="button" class="gr-star-btn" data-value="2" aria-label="2 stars">★</button>
                            <button type="button" class="gr-star-btn" data-value="3" aria-label="3 stars">★</button>
                            <button type="button" class="gr-star-btn" data-value="4" aria-label="4 stars">★</button>
                            <button type="button" class="gr-star-btn" data-value="5" aria-label="5 stars">★</button>

                            <span class="gr-pill gr-picked-label">Pick a rating</span>
                        </div>

                        <button type="submit" class="gr-btn gr-btn-secondary gr-rate-submit" disabled>
                            Rate
                        </button>
                    </form>

                </article>

                <div class="gr-actions" style="margin-top: 6px;">
                    <a th:href="@{/profile}" class="gr-btn gr-btn-secondary">← Back to Profile</a>
                </div>
            </div>

        </div>
    </section>

    <script>
        function fillStars(container, value) {
            container.querySelectorAll(".gr-star-btn").forEach(btn => {
                const v = Number(btn.dataset.value);
                btn.classList.toggle("filled", v <= value);
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".gr-rate-stars-form").forEach(form => {
                const stars = form.querySelector(".gr-stars-picker");
                const scoreInput = form.querySelector(".gr-score-input");
                const submitBtn = form.querySelector(".gr-rate-submit");
                const label = form.querySelector(".gr-picked-label");

                let selected = 0;

                stars.querySelectorAll(".gr-star-btn").forEach(btn => {
                    const value = Number(btn.dataset.value);

                    // hover preview
                    btn.addEventListener("mouseenter", () => fillStars(stars, value));
                    btn.addEventListener("mouseleave", () => fillStars(stars, selected));

                    // click select
                    btn.addEventListener("click", () => {
                        selected = value;
                        scoreInput.value = String(value);
                        fillStars(stars, selected);

                        submitBtn.disabled = false;
                        label.textContent = value + " / 5";
                    });
                });

                // safety: prevent submit without selection
                form.addEventListener("submit", (e) => {
                    if (!scoreInput.value) e.preventDefault();
                });
            });
        });
    </script>
</main>
</html>