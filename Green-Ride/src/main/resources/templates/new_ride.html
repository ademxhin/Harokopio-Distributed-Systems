<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">

<th:block layout:fragment="head">
    <title>Create Ride | GreenRide</title>
    <link rel="stylesheet" th:href="@{/css/new_ride.css}">
</th:block>

<main layout:fragment="main" class="gr-ride-page">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-sm-11 col-md-8 col-lg-6">
                <div class="gr-ride-card">
                    <div class="gr-ride-header">
                        <h2 class="gr-ride-title">Create Ride</h2>
                    </div>

                    <form th:action="@{/rides/offer}" th:object="${rideForm}" method="post" class="gr-ride-form">
                        <div class="gr-field">
                            <label class="gr-label">Origin</label>
                            <input type="text" class="gr-control" th:field="*{origin}" required>
                        </div>

                        <div class="gr-field">
                            <label class="gr-label">Destination</label>
                            <input type="text" class="gr-control" th:field="*{destination}" required>
                        </div>

                        <div class="gr-grid-2">
                            <div class="gr-field">
                                <label class="gr-label" for="date">Date</label>
                                <input class="gr-control" id="date" type="date" th:field="*{date}" required>
                            </div>

                            <div class="gr-field">
                                <label class="gr-label" for="time">Time</label>
                                <select class="gr-control" id="time" th:field="*{time}" required>
                                </select>
                            </div>
                        </div>

                        <div class="gr-field">
                            <label class="gr-label">Available Seats (1â€“4)</label>
                            <input type="number" class="gr-control" th:field="*{seatsAvailable}" min="1" max="4" required>
                        </div>

                        <button type="submit" class="gr-btn gr-btn-primary w-100">Publish Ride</button>
                    </form>
                </div>

                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        const dateEl = document.getElementById("date");
                        const timeEl = document.getElementById("time");
                        if (!dateEl || !timeEl) return;

                        function pad2(n){ return String(n).padStart(2, "0"); }

                        function updateTimeOptions() {
                            const now = new Date();
                            const selectedDate = dateEl.value;
                            const todayStr = `${now.getFullYear()}-${pad2(now.getMonth() + 1)}-${pad2(now.getDate())}`;

                            const minTimeLimit = new Date(now.getTime() + 10 * 60 * 1000);

                            const previousValue = timeEl.value;
                            timeEl.innerHTML = "";
                            const stepMinutes = 10;

                            for (let h = 0; h < 24; h++) {
                                for (let m = 0; m < 60; m += stepMinutes) {
                                    const value = `${pad2(h)}:${pad2(m)}`;
                                    const isPM = h >= 12;
                                    let h12 = h % 12 || 12;
                                    const label = `${pad2(h12)}:${pad2(m)} ${isPM ? "PM" : "AM"}`;

                                    if (selectedDate === todayStr) {
                                        const optionTime = new Date(now.getTime());
                                        optionTime.setHours(h, m, 0, 0);
                                        if (optionTime < minTimeLimit) continue;
                                    }

                                    const opt = document.createElement("option");
                                    opt.value = value;
                                    opt.textContent = label;
                                    timeEl.appendChild(opt);
                                }
                            }
                            if (previousValue) timeEl.value = previousValue;
                        }

                        const now = new Date();
                        const todayStr = `${now.getFullYear()}-${pad2(now.getMonth() + 1)}-${pad2(now.getDate())}`;
                        dateEl.min = todayStr;
                        if (!dateEl.value) dateEl.value = todayStr;

                        dateEl.addEventListener("change", updateTimeOptions);
                        updateTimeOptions();
                    });
                </script>
            </div>
        </div>
    </div>
</main>
</html>